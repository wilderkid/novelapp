# StoryForge (故事熔炉) 启动指南

本指南旨在帮助开发者，特别是初次接触本项目的新手，顺利完成 StoryForge 项目的本地环境搭建和启动。

## 目录
- [StoryForge (故事熔炉) 启动指南](#storyforge-故事熔炉-启动指南)
  - [目录](#目录)
  - [1. 环境准备](#1-环境准备)
  - [2. 安装步骤](#2-安装步骤)
    - [2.1. 自动化安装 (推荐)](#21-自动化安装-推荐)
    - [2.2. 手动安装 (适用于解决问题)](#22-手动安装-适用于解决问题)
      - [2.2.1. 克隆或下载项目](#221-克隆或下载项目)
      - [2.2.2. 安装后端依赖](#222-安装后端依赖)
      - [2.2.3. 安装前端依赖](#223-安装前端依赖)
      - [2.2.4. 配置数据库](#224-配置数据库)
      - [2.2.5. 配置环境变量](#225-配置环境变量)
  - [3. 启动应用](#3-启动应用)
    - [3.1. 使用脚本启动](#31-使用脚本启动)
    - [3.2. 手动启动](#32-手动启动)
      - [3.2.1. 启动后端服务](#321-启动后端服务)
      - [3.2.2. 启动前端应用](#322-启动前端应用)
  - [4. 访问应用](#4-访问应用)
  - [5. 常见问题 (FAQ)](#5-常见问题-faq)

---

## 1. 环境准备

在开始之前，请确保您的电脑上已经安装了以下软件。

| 软件 | 版本建议 | 安装验证 |
| :--- | :--- | :--- |
| **Python** | 3.8 或更高 | `python --version` |
| **Node.js** | 14.0 或更高 | `node --version` 和 `npm --version` |
| **PostgreSQL** | 任意稳定版本 | 确保服务正在运行 |

**重要提示:**
- 请确保 `python`, `node`, `npm` 命令已被添加到系统的环境变量中，可以在命令行/终端中直接运行。
- 如果命令未找到，请先搜索如何将它们添加到系统环境变量。

---

## 2. 安装步骤

### 2.1. 自动化安装 (推荐)

项目根目录提供了 `install.bat` (适用于 Windows CMD) 和 `install.ps1` (适用于 PowerShell) 脚本，可以一键完成大部分安装工作。

**操作:**
- **对于 CMD 用户:** 直接双击 `install.bat` 或在命令行中运行 `install.bat`。
- **对于 PowerShell 用户:** 右键以管理员身份运行 PowerShell，然后执行 `.\install.ps1`。

**该脚本会自动完成以下工作:**
1.  安装前端所有 `npm` 依赖。
2.  在 `backend` 目录下创建 Python 虚拟环境 (`venv`)。
3.  激活虚拟环境并安装所有 `pip` 依赖。
4.  在 `backend` 目录下，从 `.env.example` 复制生成 `.env` 文件，用于存放环境变量。

**自动化安装后，您仍需手动完成 [数据库配置](#224-配置数据库)。**

### 2.2. 手动安装 (适用于解决问题)

如果自动化脚本执行失败，或者您想更深入地了解项目结构，请遵循以下步骤手动安装。

#### 2.2.1. 克隆或下载项目

将项目代码克隆或下载到您的本地电脑。

#### 2.2.2. 安装后端依赖

后端使用 Python 虚拟环境以避免与系统环境产生冲突。

```bash
# 1. 进入后端目录
cd backend

# 2. 创建一个名为 venv 的虚拟环境
python -m venv venv

# 3. 激活虚拟环境
#    - Windows CMD:
call venv\Scripts\activate.bat
#    - Windows PowerShell:
#      (如果提示执行策略问题，请先以管理员身份运行 Set-ExecutionPolicy RemoteSigned -Scope CurrentUser)
.\venv\Scripts\Activate.ps1
#    - macOS / Linux:
#      source venv/bin/activate

# 4. (可选但推荐) 升级 pip
python -m pip install --upgrade pip

# 5. 安装所有 Python 依赖
pip install -r requirements.txt

# 6. 完成后可以停留在当前激活的虚拟环境中，或输入 deactivate 退出
```

#### 2.2.3. 安装前端依赖

```bash
# 1. (新开一个命令行窗口) 进入前端目录
cd frontend

# 2. 安装所有 npm 依赖
#    如果因网络问题安装缓慢或失败，可以尝试配置淘宝镜像源:
#    npm config set registry https://registry.npmmirror.com
npm install
```

#### 2.2.4. 配置数据库

1.  **启动 PostgreSQL 服务**。
2.  **创建数据库**:
    -   您可以使用 `pgAdmin` 等图形化工具，或使用 `psql` 命令行。
    -   创建一个新的数据库，命名为 `storyforge`。
    ```sql
    -- 使用 psql 命令行创建数据库
    CREATE DATABASE storyforge;
    ```
3.  **初始化表结构和默认数据**:
    -   **重要**: 项目已配置自动初始化功能，当您首次启动后端服务时，会自动：
        -   创建所有必需的数据库表
        -   插入默认的小说类型数据
        -   修复现有数据的时间戳字段
    -   **无需手动执行 SQL 脚本**，只需确保数据库已创建并正确配置连接信息即可。
    -   如果需要手动初始化或修复时间戳，可以运行：
    ```bash
    cd backend
    # 初始化默认数据
    python init_default_data.py
    # 修复现有数据的时间戳(可选)
    python update_timestamps.py
    ```

#### 2.2.5. 配置环境变量

1.  进入 `backend` 目录。
2.  复制 `.env.example` 文件并重命名为 `.env`。
3.  打开 `.env` 文件，根据您的本地环境修改以下配置：

```env
# 数据库配置 (请务必修改您的密码)
DATABASE_URL=postgresql://postgres:您的密码@localhost/storyforge

# AI API配置 (可选，如果需要使用AI功能)
AI_API_URL=https://api.chatanywhere.tech/v1
AI_API_KEY=您的API密钥
AI_MODEL=gpt-3.5-turbo
# ... 其他配置

# 应用配置 (通常无需修改)
DEBUG=True
HOST=0.0.0.0
PORT=9009
```

---

## 3. 启动应用

### 3.1. 使用脚本启动

项目根目录提供了 `start.bat` 和 `start.ps1` 脚本，可以一键启动前后端服务。

**该脚本会自动完成以下工作:**
1.  激活后端的 Python 虚拟环境。
2.  在一个新的命令行窗口中启动后端 FastAPI 服务。
3.  在另一个新的命令行窗口中启动前端 Vite 开发服务器。

### 3.2. 手动启动

#### 3.2.1. 启动后端服务

```bash
# 1. 进入后端目录
cd backend

# 2. 激活虚拟环境 (如果尚未激活)
call venv\Scripts\activate.bat

# 3. 启动 FastAPI 应用
python main.py
```
启动成功后，您会看到类似 `Uvicorn running on http://127.0.0.1:9009` 的输出。

#### 3.2.2. 启动前端应用

```bash
# 1. (新开一个命令行窗口) 进入前端目录
cd frontend

# 2. 启动 Vite 开发服务器
npm run dev
```
启动成功后，您会看到 Vite 服务的访问地址，通常是 `http://localhost:5173`。

---

## 4. 访问应用

- **前端应用地址**: [http://localhost:5173](http://localhost:5173)
- **后端API地址**: [http://localhost:9009](http://localhost:9009)
- **API文档地址 (Swagger UI)**: [http://localhost:9009/docs](http://localhost:9009/docs)

---

## 5. 常见问题 (FAQ)

**Q: 命令行提示 `python` 或 `node` 不是内部或外部命令?**
**A:** 这是因为 Python 或 Node.js 没有被正确添加到系统的环境变量 `Path` 中。请重新安装它们，并确保在安装过程中勾选 "Add to PATH" 或类似的选项。

**Q: `npm install` 或 `pip install` 很慢或失败?**
**A:** 这通常是网络问题。
-   对于 `npm`，可以尝试切换到淘宝镜像源：`npm config set registry https://registry.npmmirror.com`。
-   对于 `pip`，可以临时使用国内镜像源：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt`。

**Q: 数据库连接失败?**
**A:** 请检查以下几点：
1.  确保 PostgreSQL 服务正在您的电脑上运行。
2.  检查 `backend/.env` 文件中的 `DATABASE_URL` 是否配置正确，特别是用户名、密码、数据库名和端口。
3.  确保名为 `storyforge` 的数据库已经被创建。

**Q: `start.bat` 闪退或未正常启动?**
**A:** 脚本默认会打开新的命令行窗口来运行服务。如果闪退，很可能是程序启动时发生了错误。请尝试使用 [手动启动](#32-手动启动) 的方法，这样您就可以在命令行窗口中看到详细的错误信息。