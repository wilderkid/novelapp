### 项目名称

**StoryForge (故事熔炉)**

**愿景**: 打造一个以数据为驱动、AI 为助力的智能小说创作环境，让作者从繁琐的设定管理中解放出来，专注于叙事本身。

---

### 技术栈

*   **前端框架**: **Electron + Vue3**
    *   **Electron**: 将你的 Web 应用打包成 Windows 桌面程序。
    *   **Vue3**: 用于构建用户界面，其组合式 API 和响应式系统非常适合构建复杂的应用。
*   **富文本编辑器**: **UEditorPlus**
    *   **简介**: 基于 UEditor 的增强版，提供了更现代的 UI 和更丰富的功能。
    *   **集成方式**: 将作为 Vue3 的一个自定义组件进行集成，以便更好地与 Vue 的响应式系统结合。
*   **后端框架**: **Python + FastAPI**
    *   **FastAPI**: 一个现代、高性能的 Python Web 框架，非常适合构建本地 API 服务。
*   **数据库**: **PostgreSQL**
    *   你已经安装，它强大的 JSONB 支持是实现“一切皆变量”的关键。
*   **AI 服务**: **OpenAI Http 兼容格式调用API**
    *   通过 Python 后端进行调用，为软件提供强大的生成能力。

---

### 核心设计：变量系统与AI交互

这是整个项目的灵魂。我们将不再预设具体的“AI功能”，而是提供一个通用的交互界面。

#### 1. 数据库中的“变量”

你的数据库就是变量的来源。我们将设计以下几个核心的表：

*   **项目表**: 存储小说的基本信息，如 `title` (标题), `genre` (类型)。
*   **角色表**: 这是核心。
    *   `name`: 角色名。
    *   `details` (JSONB类型): 存放所有动态属性，例如 `{ "personality": ["勇敢", "鲁莽"], "background": "..." }`。
*   **世界观设定表**:
    *   `name`: 设定名称 (如"霍格沃茨")。
    *   `type`: 设定类型 (如"地点", "组织")。
    *   `description` (JSONB类型): 存放详细描述。
*   **章节表**:
    *   `title`: 章节标题。
    *   `content`: 章节正文。

这些表中的每一个字段，特别是 JSONB 内部的每一个键值对，都可以成为一个可引用的变量。

#### 2. AI助手面板

这是软件与AI交互的唯一入口，但功能极其强大。

*   **界面**: 一个常驻的侧边栏，包含一个大的输入框和结果显示区。
*   **变量引用语法**: 用户在输入框中，使用 `{{变量名}}` 的语法来调用数据。
    *   `{{project.title}}`: 引用项目标题。
    *   `{{character.李昂.details.personality}}`: 引用角色“李昂”的“性格”。
    *   `{{world.霍格沃茨.description}}`: 引用“霍格沃茨”的描述。
    *   `{{selection}}`: 一个特殊变量，代表用户在编辑器中选中的文本。
*   **智能提示**: 当用户输入 `{{` 时，自动弹出变量列表供选择，无需记忆。

#### 3. UEditorPlus 的深度集成

UEditorPlus 不仅仅是一个输入框，它将成为我们变量系统的可视化载体。

*   **自定义变量渲染**:
    *   我们将扩展 UEditorPlus，使其能够识别并特殊渲染 `{{...}}` 语法。
    *   当用户在编辑器中输入 `{{character.李昂}}` 时，它将不再显示为纯文本，而是渲染成一个带有特殊背景色、不可编辑的“实体块”。
    *   鼠标悬浮在这个“实体块”上时，会以 tooltip 的形式显示该角色的核心信息（如性格、背景）。
    *   点击这个“实体块”，可以快速跳转到该角色的详细设定页面。
*   **工具栏集成**:
    *   在 UEditorPlus 的工具栏上，我们将添加一个“插入变量”的按钮。
    *   点击此按钮，会弹出一个与 AI 助手面板相同的变量选择器，方便用户在不手动输入 `{{...}}` 的情况下插入变量。
*   **内容同步**:
    *   编辑器的内容（包含渲染后的变量实体块）在提交到后端时，需要能被正确地转换回包含 `{{...}}` 语法的纯文本字符串，以便进行变量解析。

---

### 核心工作流

1.  **作者操作**: 在 UEditorPlus 编辑器中，作者选中一段描写，或者将光标放在需要插入内容的地方。
2.  **构建提示词**: 他打开 AI 助手面板，在输入框中写下指令，并自由组合变量：
    > “请帮我在下面这段描写后，续写一段李昂的内心独白。
    >
    > 角色信息：{{character.李昂.details}}
    >
    > 原文：{{selection}}”
3.  **后端处理**:
    *   后端接收到这个包含 `{{...}}` 的提示词。
    *   它会解析出所有变量名，去 PostgreSQL 数据库中查询对应的数据。
    *   用真实数据替换掉变量占位符，生成一个完整的、信息丰富的提示词。
    *   将这个最终提示词发送给 OpenAI API。
4.  **结果呈现**:
    *   AI 生成的内容返回到 AI 助手面板的显示区，作者可以选择“采纳”或“忽略”。
    *   如果选择“采纳”，内容将被插入到 UEditorPlus 编辑器的光标位置，或替换选中的文本。如果生成的内容中包含新的 `{{...}}` 变量，编辑器会自动将其渲染为实体块。

---

### 开发路线图

**第一阶段：MVP (最小可行产品)**
1.  搭建好 **Electron + Vue3 + FastAPI + PostgreSQL** 的基础框架。
2.  将 **UEditorPlus** 成功集成到 Vue3 项目中，实现基本的文本编辑和保存功能。
3.  创建最核心的 `projects` 和 `characters` 表。
4.  实现一个最简单的 AI 助手面板，能解析 `{{project.title}}` 这一个变量，并与 AI 完成一次完整的交互。

**第二阶段：变量系统完善**
1.  完善 `characters`, `world_settings` 等所有数据表。
2.  开发管理这些数据的 UI 界面（角色卡片、设定集等）。
3.  实现 AI 助手面板的智能提示功能，支持所有变量的引用。
4.  **重点**: 开发 UEditorPlus 的自定义渲染功能，使 `{{...}}` 变量能在编辑器中可视化。

**第三阶段：体验优化**
1.  添加章节管理、大纲视图等辅助写作功能。
2.  实现版本控制（快照）。
3.  实现导出为 Word、PDF 等格式的功能。

